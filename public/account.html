<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - JE Fitness</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; }
        .account-container { max-width: 600px; margin: 2rem auto; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-header { background: #667eea; color: white; }
        .form-section { margin-bottom: 2rem; }
        .form-section h5 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .success-message, .error-message { display: none; margin-bottom: 1rem; }
        .loading-spinner { display: none; margin-right: 0.5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">JE Fitness</span>
            <div>
                <a href="dashboard.html" class="btn btn-sm btn-outline-light me-2">Dashboard</a>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>
    </nav>

    <div class="account-container">
        <div class="card">
            <div class="card-header">
                <h2>Account Settings</h2>
            </div>
            <div class="card-body">
                <!-- Success Alert -->
                <div id="successMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
                    <span id="successText"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Error Alert -->
                <div id="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
                    <span id="errorText"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Subscription Status -->
                <div class="form-section">
                    <h5>Subscription Status</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Current Plan</p>
                            <h6 id="currentPlan">Free</h6>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Billing Environment</p>
                            <h6 id="billingEnv">-</h6>
                        </div>
                    </div>
                    <a href="subscriptions.html" class="btn btn-primary mt-2">Manage Subscriptions</a>
                </div>

                <!-- Account Information -->
                <div class="form-section">
                    <h5>Account Information</h5>
                    <form id="accountForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" placeholder="First name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" placeholder="Last name" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" placeholder="Email" required>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <span class="loading-spinner">
                                <span class="spinner-border spinner-border-sm"></span>
                            </span>
                            Save Account Information
                        </button>
                    </form>
                </div>

                <!-- Change Password -->
                <div class="form-section">
                    <h5>Change Password</h5>
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Current password" required>
                        </div>

                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="New password" required>
                            <small class="form-text text-muted d-block mt-2">
                                Password must:
                                <ul class="mb-0 ps-3">
                                    <li>Be at least 8 characters long</li>
                                    <li>Include uppercase and lowercase letters</li>
                                    <li>Include at least one number</li>
                                    <li>Include at least one special character (!@#$%^&*)</li>
                                </ul>
                            </small>
                        </div>

                        <button type="submit" class="btn btn-warning">
                            <span class="loading-spinner">
                                <span class="spinner-border spinner-border-sm"></span>
                            </span>
                            Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Load account information on page load
        document.addEventListener('DOMContentLoaded', loadAccountInfo);

        async function loadAccountInfo() {
            try {
                const response = await fetch('/api/v1/auth/account', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login.html';
                    }
                    throw new Error('Failed to load account information');
                }

                const data = await response.json();
                
                // Populate form fields
                document.getElementById('firstName').value = data.firstName || '';
                document.getElementById('lastName').value = data.lastName || '';
                document.getElementById('email').value = data.email || '';
                
                // Display subscription info
                document.getElementById('currentPlan').textContent = data.subscriptionPlan || 'Free';
                document.getElementById('billingEnv').textContent = data.billingEnvironment || 'N/A';
            } catch (error) {
                console.error('Error loading account info:', error);
                showError('Failed to load account information. Please refresh the page.');
            }
        }

        // Handle account information form submission
        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = e.target.querySelector('button[type="submit"]');
            button.querySelector('.loading-spinner').style.display = 'inline-block';
            button.disabled = true;

            try {
                const response = await fetch('/api/v1/auth/account', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        email: document.getElementById('email').value
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.msg || 'Failed to update account');
                }

                showSuccess('Account information updated successfully!');
            } catch (error) {
                console.error('Error updating account:', error);
                showError(error.message);
            } finally {
                button.querySelector('.loading-spinner').style.display = 'none';
                button.disabled = false;
            }
        });

        // Handle password change form submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = e.target.querySelector('button[type="submit"]');
            button.querySelector('.loading-spinner').style.display = 'inline-block';
            button.disabled = true;

            try {
                const response = await fetch('/api/v1/auth/account', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: document.getElementById('currentPassword').value,
                        newPassword: document.getElementById('newPassword').value
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.msg || 'Failed to change password');
                }

                showSuccess('Password changed successfully!');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                console.error('Error changing password:', error);
                showError(error.message);
            } finally {
                button.querySelector('.loading-spinner').style.display = 'none';
                button.disabled = false;
            }
        });

        function showSuccess(message) {
            const alert = document.getElementById('successMessage');
            document.getElementById('successText').textContent = message;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 5000);
        }

        function showError(message) {
            const alert = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            alert.style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }
    </script>
</body>
</html>
