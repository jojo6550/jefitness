/**
 * Trainer Dashboard
 * Handles trainer-specific functionality and data display
 */

window.API_BASE = window.ApiConfig.getAPI_BASE();

/**
 * Initialize trainer dashboard
 */
async function initTrainerDashboard() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'pages/login.html';
        return;
    }

    try {
        // Verify user is a trainer
        const userRes = await fetch(`${window.API_BASE}/api/auth/me`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!userRes.ok) {
            logger.warn('User verification failed');
            return;
        }

        const user = await userRes.json();

        if (user.role !== 'trainer') {
            logger.warn('User is not a trainer');
            window.location.href = 'dashboard.html';
            return;
        }

        // Load dashboard data
        await loadDashboardData();
    } catch (err) {
        logger.error('Trainer dashboard initialization failed', { error: err?.message });
    }
}

/**
 * Load all dashboard data
 */
async function loadDashboardData() {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const [statsRes, clientsRes, appointmentsRes] = await Promise.all([
            fetch(`${window.API_BASE}/api/trainer/stats`, {
                headers: { Authorization: `Bearer ${token}` }
            }),
            fetch(`${window.API_BASE}/api/trainer/clients`, {
                headers: { Authorization: `Bearer ${token}` }
            }),
            fetch(`${window.API_BASE}/api/trainer/appointments`, {
                headers: { Authorization: `Bearer ${token}` }
            })
        ]);

        if (statsRes.ok) {
            const stats = await statsRes.json();
            renderStats(stats);
        }

        if (clientsRes.ok) {
            const clients = await clientsRes.json();
            renderClients(clients);
        }

        if (appointmentsRes.ok) {
            const appointments = await appointmentsRes.json();
            renderAppointments(appointments);
        }
    } catch (err) {
        logger.error('Failed to load dashboard data', { error: err?.message });
        showError('Failed to load dashboard data. Please refresh the page.');
    }
}

/**
 * Render statistics
 */
function renderStats(stats) {
    const totalClients = document.getElementById('totalClients');
    const activeClients = document.getElementById('activeClients');
    const todayAppointments = document.getElementById('todayAppointments');
    const pendingPrograms = document.getElementById('pendingPrograms');

    if (totalClients) totalClients.textContent = stats.totalClients || 0;
    if (activeClients) activeClients.textContent = stats.activeClients || 0;
    if (todayAppointments) todayAppointments.textContent = stats.todayAppointments || 0;
    if (pendingPrograms) pendingPrograms.textContent = stats.pendingPrograms || 0;
}

/**
 * Render clients list
 */
function renderClients(clients) {
    const container = document.getElementById('clientsList');
    if (!container) return;

    if (!clients || clients.length === 0) {
        container.innerHTML = '<p class="text-muted">No clients assigned yet.</p>';
        return;
    }

    container.innerHTML = clients.map(client => `
        <div class="client-card p-3 border rounded mb-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6>${client.firstName} ${client.lastName}</h6>
                    <small class="text-muted">${client.email}</small>
                </div>
                <div>
                    <span class="badge ${client.active ? 'bg-success' : 'bg-secondary'}">
                        ${client.active ? 'Active' : 'Inactive'}
                    </span>
                </div>
        </div>
    `).join('');
}

/**
 * Render appointments list
 */
function renderAppointments(appointments) {
    const container = document.getElementById('appointmentsList');
    if (!container) return;

    if (!appointments || appointments.length === 0) {
        container.innerHTML = '<p class="text-muted">No upcoming appointments.</p>';
        return;
    }

    container.innerHTML = appointments.map(apt => `
        <div class="appointment-card p-3 border rounded mb-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6>${new Date(apt.date).toLocaleDateString()} at ${apt.time}</h6>
                    <small class="text-muted">${apt.clientName}</small>
                </div>
                <div>
                    <span class="badge ${apt.status === 'scheduled' ? 'bg-primary' : apt.status === 'completed' ? 'bg-success' : 'bg-warning'}">
                        ${apt.status}
                    </span>
                    ${apt.status === 'scheduled' ? `
                        <button class="btn btn-sm btn-success ms-2" onclick="markComplete('${apt._id}')">
                            <i class="bi bi-check"></i>
                        </button>
                    ` : ''}
                </div>
        </div>
    `).join('');
}

/**
 * Mark appointment as complete
 */
async function markComplete(appointmentId) {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const response = await fetch(`${window.API_BASE}/api/appointments/${appointmentId}/complete`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            await loadDashboardData();
            showToast('Appointment marked as complete', 'success');
        } else {
            const data = await response.json();
            showError(data.error?.message || 'Failed to update appointment');
        }
    } catch (err) {
        logger.error('Failed to update appointment status', { error: err?.message });
        showError(err.message);
    }
}

/**
 * Show error message
 */
function showError(message) {
    const container = document.getElementById('errorContainer');
    if (container) {
        container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        setTimeout(() => container.innerHTML = '', 5000);
    }
}

/**
 * Show toast notification
 */
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.innerHTML = `
        <div class="toast-body">${message}</div>
    `;
    container.appendChild(toast);
    new bootstrap.Toast(toast).show();
    setTimeout(() => toast.remove(), 3000);
}

// Export functions globally
window.markComplete = markComplete;

// Initialize on load
document.addEventListener('DOMContentLoaded', initTrainerDashboard);
