<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>True Biotics Products â€“ JE Fitness</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles/styles.css?v=1.0.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicons/favicon-16x16.png">
    <link rel="manifest" href="../favicons/site.webmanifest">
</head>

<body class="products-page">
    <!-- Auth Required Modal -->
    <div class="modal fade" id="authRequiredModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-lock-fill text-warning me-2"></i>Login Required</h5>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-person-circle display-1 text-muted mb-3"></i>
                    <p class="lead">You must be logged in to view and purchase products.</p>
                </div>
                <div class="modal-footer border-0">
                    <a href="login.html" class="btn btn-primary">Login</a>
                    <a href="signup.html" class="btn btn-outline-light">Sign Up</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999">
        <div id="cartToast" class="toast align-items-center text-bg-primary border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i>
                    <span id="toastMessage">Item added to cart!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <div class="d-flex align-items-center">
                <a class="navbar-brand fw-bold me-3" href="dashboard.html" id="brand-link">JEFITNESS</a>
                <span id="subscription-status-navbar" class="badge bg-secondary text-white small">Loading...</span>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="products.html">Products</a></li>
                    <li class="nav-item"><a class="nav-link" href="subscriptions.html">Subscription</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutButton">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
    // Load subscription status for navbar
    async function loadNavbarSubscriptionStatus() {
        const statusElement = document.getElementById('subscription-status-navbar');
        if (!statusElement) return;

        try {
            const token = localStorage.getItem('token');
            if (!token) {
                statusElement.textContent = 'Not logged in';
                statusElement.className = 'badge bg-warning text-dark small';
                return;
            }

            const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
            const API_BASE = isLocalhost ? 'http://localhost:10000' : 'https://jefitness.onrender.com';

            const response = await fetch(`${API_BASE}/api/v1/subscriptions/status`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch subscription status');
            }

            const data = await response.json();

            if (data.success && data.data) {
                const subscription = data.data;
                let statusText = 'Free';
                let statusClass = 'bg-secondary';

                if (subscription.hasSubscription) {
                    if (subscription.status === 'active' || subscription.status === 'trialing') {
                        statusText = `${subscription.plan} Plan`;
                        statusClass = 'bg-success';
                    } else if (subscription.status === 'canceled' || subscription.status === 'cancel_pending') {
                        statusText = `${subscription.plan} (Canceled)`;
                        statusClass = 'bg-warning text-dark';
                    } else if (subscription.status === 'past_due') {
                        statusText = `${subscription.plan} (Past Due)`;
                        statusClass = 'bg-danger';
                    } else {
                        statusText = `${subscription.plan} (${subscription.status})`;
                        statusClass = 'bg-info';
                    }
                }

                statusElement.textContent = statusText;
                statusElement.className = `badge ${statusClass} text-white small`;
            } else {
                statusElement.textContent = 'Free';
                statusElement.className = 'badge bg-secondary text-white small';
            }
        } catch (error) {
            console.error('Error loading navbar subscription status:', error);
            statusElement.textContent = 'Error';
            statusElement.className = 'badge bg-danger text-white small';
        }
    }

    // Load subscription status when navbar is loaded
    document.addEventListener('DOMContentLoaded', loadNavbarSubscriptionStatus);
    </script>

    <!-- Loading Spinner -->
    <div id="page-loading" class="d-flex align-items-center justify-content-center min-vh-100 bg-dark">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading products...</p>
        </div>
    </div>

    <header class="hero d-flex align-items-center justify-content-center text-center text-white">
        <div class="hero-overlay"></div>
        <div class="hero-content position-relative z-1">
            <h1 class="display-3 fw-bold mb-3 animate__animated animate__fadeInDown">True Biotics Products</h1>
            <p class="lead mb-4 animate__animated animate__fadeInUp">Natural health supplements for your fitness journey.</p>
        </div>
    </header>

    <section id="products" class="container py-5">
        <div class="text-center mb-5">
            <h2 class="display-5 fw-bold mb-3">Our Products</h2>
            <p class="lead text-muted">Discover our range of natural products designed to support your health and wellness.</p>
        </div>
        <div class="row g-4 justify-content-center" id="products-container">
            <!-- Seamoss Small -->
            <div class="col-md-6 col-lg-4">
                <div class="product-card card h-100 shadow-sm text-center" data-product-id="seamoss-small">
                    <div class="card-body p-4">
                        <i class="bi bi-droplet-fill display-4 text-primary mb-3"></i>
                        <h5 class="card-title fw-bold mb-2">Seamoss - Small Size</h5>
                        <p class="card-text text-muted">Rich in minerals and vitamins, perfect for daily supplementation.</p>
                        <p class="fw-bold text-primary h4">$<span class="product-price">15.99</span></p>
                        
                        <!-- Quantity Selector -->
                        <div class="quantity-selector mb-3">
                            <label class="form-label small text-muted">Quantity</label>
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="decrease">-</button>
                                <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" style="width: 70px;" data-product="seamoss-small">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="increase">+</button>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-primary add-to-cart-btn" data-product-id="seamoss-small" data-product-name="Seamoss - Small Size" data-price="15.99">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#seamossSmallModal">Learn More</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seamoss Large -->
            <div class="col-md-6 col-lg-4">
                <div class="product-card card h-100 shadow-sm text-center" data-product-id="seamoss-large">
                    <div class="card-body p-4">
                        <i class="bi bi-droplet-fill display-4 text-primary mb-3"></i>
                        <h5 class="card-title fw-bold mb-2">Seamoss - Large Size</h5>
                        <p class="card-text text-muted">Larger quantity for extended use, packed with essential nutrients.</p>
                        <p class="fw-bold text-primary h4">$<span class="product-price">25.99</span></p>
                        
                        <!-- Quantity Selector -->
                        <div class="quantity-selector mb-3">
                            <label class="form-label small text-muted">Quantity</label>
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="decrease">-</button>
                                <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" style="width: 70px;" data-product="seamoss-large">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="increase">+</button>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-primary add-to-cart-btn" data-product-id="seamoss-large" data-product-name="Seamoss - Large Size" data-price="25.99">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#seamossLargeModal">Learn More</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coconut Water -->
            <div class="col-md-6 col-lg-4">
                <div class="product-card card h-100 shadow-sm text-center" data-product-id="coconut-water">
                    <div class="card-body p-4">
                        <i class="bi bi-cup-straw display-4 text-success mb-3"></i>
                        <h5 class="card-title fw-bold mb-2">Coconut Water</h5>
                        <p class="card-text text-muted">Hydrating and refreshing, naturally rich in electrolytes.</p>
                        <p class="fw-bold text-primary h4">$<span class="product-price">8.99</span></p>
                        
                        <!-- Quantity Selector -->
                        <div class="quantity-selector mb-3">
                            <label class="form-label small text-muted">Quantity</label>
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="decrease">-</button>
                                <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" style="width: 70px;" data-product="coconut-water">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="increase">+</button>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-primary add-to-cart-btn" data-product-id="coconut-water" data-product-name="Coconut Water" data-price="8.99">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#coconutWaterModal">Learn More</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coconut Jelly -->
            <div class="col-md-6 col-lg-4">
                <div class="product-card card h-100 shadow-sm text-center" data-product-id="coconut-jelly">
                    <div class="card-body p-4">
                        <i class="bi bi-egg-fried display-4 text-warning mb-3"></i>
                        <h5 class="card-title fw-bold mb-2">Coconut Jelly</h5>
                        <p class="card-text text-muted">Delicious and nutritious, a great snack for energy boost.</p>
                        <p class="fw-bold text-primary h4">$<span class="product-price">12.99</span></p>
                        
                        <!-- Quantity Selector -->
                        <div class="quantity-selector mb-3">
                            <label class="form-label small text-muted">Quantity</label>
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="decrease">-</button>
                                <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" style="width: 70px;" data-product="coconut-jelly">
                                <button class="btn btn-outline-secondary quantity-btn" data-action="increase">+</button>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-primary add-to-cart-btn" data-product-id="coconut-jelly" data-product-name="Coconut Jelly" data-price="12.99">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#coconutJellyModal">Learn More</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coming Soon -->
            <div class="col-md-6 col-lg-4">
                <div class="product-card card h-100 shadow-sm text-center opacity-75">
                    <div class="card-body p-4">
                        <i class="bi bi-plus-circle-fill display-4 text-info mb-3"></i>
                        <h5 class="card-title fw-bold mb-2">Other Products</h5>
                        <p class="card-text text-muted">Explore our full range of natural health products.</p>
                        <p class="fw-bold text-muted h4">Coming Soon</p>
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="bi bi-clock me-2"></i>Coming Soon
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Product Description Modals -->
    <div class="modal fade" id="seamossSmallModal" tabindex="-1" aria-labelledby="seamossSmallModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="seamossSmallModalLabel">Seamoss - Small Size</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle-fill text-primary me-2"></i>Storage</h6>
                            <p>Store in a cool, dry place away from direct sunlight. Keep in an airtight container to maintain freshness. Refrigerate after opening for extended shelf life.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle-fill text-success me-2"></i>Uses</h6>
                            <ul>
                                <li>Daily mineral and vitamin supplementation</li>
                                <li>Thyroid support</li>
                                <li>Digestive health</li>
                                <li>Immune system boost</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6><i class="bi bi-star-fill text-warning me-2"></i>Overall Facts</h6>
                        <p>Seamoss is a nutrient-dense seaweed rich in iodine, potassium, calcium, and over 90 other minerals. It's naturally vegan, gluten-free, and supports overall wellness. Each serving provides essential trace minerals that may be lacking in modern diets.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="seamossLargeModal" tabindex="-1" aria-labelledby="seamossLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="seamossLargeModalLabel">Seamoss - Large Size</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle-fill text-primary me-2"></i>Storage</h6>
                            <p>Store in a cool, dry place away from direct sunlight. Keep in an airtight container to maintain freshness. Refrigerate after opening for extended shelf life. Larger size allows for bulk storage solutions.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle-fill text-success me-2"></i>Uses</h6>
                            <ul>
                                <li>Extended daily supplementation</li>
                                <li>Family or group nutrition</li>
                                <li>Thyroid and hormonal support</li>
                                <li>Detoxification and cleansing</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6><i class="bi bi-star-fill text-warning me-2"></i>Overall Facts</h6>
                        <p>Our large size Seamoss provides the same nutrient-dense benefits as the small size but in a more economical package. Rich in iodine, potassium, calcium, and over 90 minerals. Perfect for those committed to long-term wellness routines. Naturally vegan and supports sustainable health practices.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="coconutWaterModal" tabindex="-1" aria-labelledby="coconutWaterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="coconutWaterModalLabel">Coconut Water</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle-fill text-primary me-2"></i>Storage</h6>
                            <p>Refrigerate immediately after opening. Consume within 2-3 days for best quality. Store unopened bottles in a cool, dry place. Do not freeze.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle-fill text-success me-2"></i>Uses</h6>
                            <ul>
                                <li>Natural hydration during workouts</li>
                                <li>Electrolyte replenishment</li>
                                <li>Post-exercise recovery drink</li>
                                <li>Refreshing beverage alternative</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6><i class="bi bi-star-fill text-warning me-2"></i>Overall Facts</h6>
                        <p>Pure coconut water is nature's sports drink, containing essential electrolytes like potassium, magnesium, and calcium. It's low in calories, naturally fat-free, and provides quick hydration. Our coconut water is sourced from fresh, young coconuts for maximum nutritional value.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="coconutJellyModal" tabindex="-1" aria-labelledby="coconutJellyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="coconutJellyModalLabel">Coconut Jelly</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle-fill text-primary me-2"></i>Storage</h6>
                            <p>Store in a cool, dry place. Refrigerate after opening. Consume within 7-10 days after opening for best quality. Keep in original packaging to maintain freshness.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle-fill text-success me-2"></i>Uses</h6>
                            <ul>
                                <li>Healthy snack alternative</li>
                                <li>Energy boost between meals</li>
                                <li>Dessert option for clean eating</li>
                                <li>Quick nutrition on-the-go</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6><i class="bi bi-star-fill text-warning me-2"></i>Overall Facts</h6>
                        <p>Coconut jelly is made from the pure, natural sap of coconut blossoms. It's rich in amino acids, vitamins, and minerals. Low in calories but high in nutrients, it provides sustained energy without the sugar crash. Naturally sweet and perfect for maintaining healthy blood sugar levels.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p class="mb-2">&copy; 2025 JE Fitness. All rights reserved.</p>
            <div class="d-flex justify-content-center gap-4">
                <a href="https://www.instagram.com/je_fitness.ja/" target="_blank" class="text-white fs-3"><i class="bi bi-instagram"></i></a>
                <a href="https://wa.me/18762064114" target="_blank" class="text-white fs-3"><i class="bi bi-whatsapp"></i></a>
                <a href="mailto:JEFITNESS876@gmail.com" class="text-white fs-3"><i class="bi bi-envelope-fill"></i></a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API configuration
        const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
        const API_BASE = isLocalhost ? 'http://localhost:10000' : 'https://jefitness.onrender.com';

        // Product icons and colors mapping based on Stripe product metadata
        const PRODUCT_STYLES = {
            'bi-droplet-fill': { color: 'primary', icon: 'bi-droplet-fill' },
            'bi-cup-straw': { color: 'success', icon: 'bi-cup-straw' },
            'bi-egg-fried': { color: 'warning', icon: 'bi-egg-fried' },
            'bi-heart-pulse': { color: 'danger', icon: 'bi-heart-pulse' },
            'bi-gem': { color: 'info', icon: 'bi-gem' },
            'bi-tree': { color: 'success', icon: 'bi-tree' },
            'bi-cup-hot': { color: 'warning', icon: 'bi-cup-hot' },
            'bi-basket': { color: 'primary', icon: 'bi-basket' },
            'bi-box-seam': { color: 'secondary', icon: 'bi-box-seam' },
            'bi-leaf': { color: 'success', icon: 'bi-leaf' }
        };

        // Default style for products without specific metadata
        const DEFAULT_STYLE = { color: 'primary', icon: 'bi-box-seam' };

        // Cart state (loaded from localStorage)
        let cart = JSON.parse(localStorage.getItem('productCart') || '{"items": []}');
        
        // Products loaded from Stripe
        let productsFromStripe = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                // Show auth required modal
                const authModal = new bootstrap.Modal(document.getElementById('authRequiredModal'));
                authModal.show();
                document.getElementById('page-loading').style.display = 'none';
                return;
            }

            // Hide loading spinner temporarily
            document.getElementById('page-loading').style.display = 'flex';

            try {
                // Fetch products from Stripe
                await loadProductsFromStripe();
                
                // Sync with server cart
                await syncCartWithServer();

                // Setup event listeners
                setupQuantityControls();
                setupLogout();
                
                // Load cart count
                updateCartBadge();

                // Hide loading spinner
                document.getElementById('page-loading').style.display = 'none';
            } catch (error) {
                console.error('Failed to load products:', error);
                document.getElementById('page-loading').innerHTML = `
                    <div class="text-center">
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load products. Please try again later.
                        </div>
                        <button class="btn btn-primary mt-3" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Retry
                        </button>
                    </div>
                `;
            }
        });

        // Load products from Stripe API
        async function loadProductsFromStripe() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/api/v1/products`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!res.ok) {
                throw new Error('Failed to fetch products from Stripe');
            }

            const data = await res.json();
            
            if (data.success && data.data && data.data.products) {
                productsFromStripe = data.data.products;
                renderProducts(productsFromStripe);
            } else {
                throw new Error('Invalid response from products API');
            }
        }

        // Render products dynamically based on Stripe data
        function renderProducts(products) {
            const container = document.getElementById('products-container');
            
            // Clear existing products (keep the "Coming Soon" card)
            const comingSoonCard = container.querySelector('.opacity-75');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-info-circle display-1 text-muted mb-3"></i>
                        <h4 class="text-muted">No products available at this time.</h4>
                        <p class="text-muted">Please check back later.</p>
                    </div>
                `;
                return;
            }

            // Add product cards
            products.forEach(product => {
                const style = PRODUCT_STYLES[product.metadata?.icon] || 
                              PRODUCT_STYLES[product.images?.[0]] || 
                              DEFAULT_STYLE;
                
                const price = product.price ? (product.price / 100).toFixed(2) : 'N/A';
                const priceId = product.priceId || '';
                const productId = product.id;
                const productName = product.name;
                const description = product.description || '';
                
                const cardHtml = `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card card h-100 shadow-sm text-center" data-product-id="${productId}">
                            <div class="card-body p-4">
                                <i class="bi ${style.icon} display-4 text-${style.color} mb-3"></i>
                                <h5 class="card-title fw-bold mb-2">${productName}</h5>
                                <p class="card-text text-muted">${description || 'No description available.'}</p>
                                <p class="fw-bold text-${style.color} h4">$<span class="product-price">${price}</span></p>
                                
                                <!-- Quantity Selector -->
                                <div class="quantity-selector mb-3">
                                    <label class="form-label small text-muted">Quantity</label>
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <button class="btn btn-outline-secondary quantity-btn" data-action="decrease">-</button>
                                        <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" style="width: 70px;" data-product="${productId}">
                                        <button class="btn btn-outline-secondary quantity-btn" data-action="increase">+</button>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-primary add-to-cart-btn" 
                                        data-product-id="${productId}" 
                                        data-product-name="${productName}" 
                                        data-price="${product.price || 0}"
                                        data-price-id="${priceId}">
                                        <i class="bi bi-cart-plus me-2"></i>Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Add "Coming Soon" card if there are fewer than 3 products
            if (products.length < 3) {
                const comingSoonHtml = `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card card h-100 shadow-sm text-center opacity-75">
                            <div class="card-body p-4">
                                <i class="bi bi-plus-circle-fill display-4 text-info mb-3"></i>
                                <h5 class="card-title fw-bold mb-2">Other Products</h5>
                                <p class="card-text text-muted">Explore our full range of natural health products.</p>
                                <p class="fw-bold text-muted h4">Coming Soon</p>
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="bi bi-clock me-2"></i>Coming Soon
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', comingSoonHtml);
            }

            // Setup Add to Cart buttons after rendering
            setupAddToCartButtons();
        }

        // Sync local cart with server
        async function syncCartWithServer() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/api/v1/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.data && data.data.cart && data.data.cart.items && data.data.cart.items.length > 0) {
                        // Use server cart as source of truth for item data
                        cart = {
                            items: data.data.cart.items,
                            createdAt: data.data.cart.createdAt,
                            updatedAt: data.data.cart.updatedAt
                        };
                        localStorage.setItem('productCart', JSON.stringify(cart));
                    }
                }
            } catch (err) {
                console.warn('Could not sync with server cart, using local cart');
            }
        }

        // Setup quantity increment/decrement controls
        function setupQuantityControls() {
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    const input = e.target.parentElement.querySelector('.quantity-input');
                    let value = parseInt(input.value) || 1;
                    
                    if (action === 'increase') {
                        value = Math.min(value + 1, 99);
                    } else if (action === 'decrease') {
                        value = Math.max(value - 1, 1);
                    }
                    
                    input.value = value;
                });
            });

            // Handle manual input changes
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    let value = parseInt(e.target.value) || 1;
                    value = Math.max(1, Math.min(value, 99));
                    e.target.value = value;
                });
            });
        }

        // Setup Add to Cart buttons
        function setupAddToCartButtons() {
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const productId = button.dataset.productId;
                    const productName = button.dataset.productName;
                    const price = parseFloat(button.dataset.price) / 100; // Convert from cents to dollars
                    const priceId = button.dataset.priceId;
                    const quantity = parseInt(document.querySelector(`.quantity-input[data-product="${productId}"]`).value) || 1;
                    
                    addToCart(productId, productName, price, priceId, quantity);
                });
            });
        }

        // Add item to cart
        async function addToCart(productId, productName, price, priceId, quantity) {
            // Find the Stripe product to get latest price
            const stripeProduct = productsFromStripe.find(p => p.id === productId);
            const currentPrice = stripeProduct?.price || Math.round(price * 100);
            const currentPriceId = stripeProduct?.priceId || priceId;

            // Check if item already in cart
            const existingItem = cart.items.find(item => item.productId === productId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.items.push({
                    productId,
                    name: productName,
                    price: currentPrice, // Store in cents
                    priceId: currentPriceId,
                    quantity
                });
            }

            // Save to localStorage
            saveCart();

            // Sync with server (fire and forget)
            syncToServer(productId, quantity);

            // Update badge
            updateCartBadge();

            // Show toast
            showToast(`${quantity}x ${productName} added to cart!`);
        }

        // Sync cart changes to server
        async function syncToServer(productId, quantity) {
            try {
                const token = localStorage.getItem('token');
                const item = cart.items.find(i => i.productId === productId);
                if (!item) return;

                await fetch(`${API_BASE}/api/v1/cart/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        productId,
                        name: item.name,
                        price: item.price, // Already in cents
                        quantity
                    })
                });
            } catch (err) {
                console.warn('Could not sync cart to server');
            }
        }

        // Save cart to localStorage
        function saveCart() {
            localStorage.setItem('productCart', JSON.stringify(cart));
        }

        // Update cart badge
        function updateCartBadge() {
            const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-badge');
            
            if (totalItems > 0) {
                badge.textContent = totalItems;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('cartToast');
            document.getElementById('toastMessage').textContent = message;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Setup logout button
        function setupLogout() {
            document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('productCart');
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>
