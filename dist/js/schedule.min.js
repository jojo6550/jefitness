document.addEventListener("DOMContentLoaded",()=>{let o=document.getElementById("dailyPlanForm"),i=document.getElementById("planDay"),l=document.getElementById("planTitle"),r=document.getElementById("planNotes"),e=document.getElementById("weeklyScheduleDisplay"),s={lastReset:(new Date).toISOString(),plans:[]},n=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];async function d(){try{(await fetch("/api/auth/schedule",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({schedule:s})})).ok||console.error("Failed to save schedule")}catch(e){console.error("Error saving schedule:",e)}}function t(){let t=s.plans.map(e=>e.day);i.innerHTML='<option value="">Choose...</option>',n.forEach(e=>{t.includes(e)||(i.innerHTML+=`<option value="${e}">${u(e)}</option>`)})}function c(){if(0===s.plans.length)e.innerHTML='<div class="text-muted text-center py-3">No plans set for this week.</div>',t();else{let a='<ul class="list-group">';s.plans.forEach((e,t)=>{var n=e.planTitles.join(" and ");a+=`<li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${u(e.day)}</strong>: ${n}
                            ${e.notes?`<br><small>${e.notes}</small>`:""}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" data-action="edit" data-index="${t}">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-index="${t}">Delete</button>
                        </div>
                    </li>`}),a+="</ul>",e.innerHTML=a,t(),document.querySelectorAll('button[data-action="edit"]').forEach(n=>{n.addEventListener("click",()=>{var e,t=parseInt(n.getAttribute("data-index"));t=t,e=s.plans[t],i.value=e.day,l.value=e.planTitles.join(" and "),r.value=e.notes||"",s.plans.splice(t,1),c()})}),document.querySelectorAll('button[data-action="delete"]').forEach(e=>{e.addEventListener("click",()=>{(async e=>{confirm("Are you sure you want to delete this plan?")&&(s.plans.splice(e,1),await d(),c())})(parseInt(e.getAttribute("data-index")))})})}}function u(e){return e.charAt(0).toUpperCase()+e.slice(1)}async function p(){try{var e=await fetch("/api/appointments/user",{headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(e.ok){var t=await e.json(),n=document.getElementById("appointmentsDisplay");if(0===t.length)n.innerHTML='<div class="text-muted text-center py-3">No appointments scheduled.</div>';else{let a='<ul class="list-group">';t.forEach(e=>{var t=new Date(e.date).toLocaleDateString(),n="scheduled"===e.status?"text-success":"cancelled"===e.status?"text-danger":"text-warning";a+=`<li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${t} at ${e.time}</strong> with ${e.trainerId.firstName} ${e.trainerId.lastName}
                            <br><small class="${n}">Status: ${e.status}</small>
                            ${e.notes?`<br><small>${e.notes}</small>`:""}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" data-action="delete-appointment" data-id="${e._id}">Delete</button>
                        </div>
                    </li>`}),a+="</ul>",n.innerHTML=a,document.querySelectorAll('button[data-action="delete-appointment"]').forEach(e=>{e.addEventListener("click",()=>{(async e=>{if(confirm("Are you sure you want to delete this appointment?"))try{(await fetch("/api/appointments/"+e,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}})).ok?p():alert("Failed to delete appointment")}catch(e){console.error("Error deleting appointment:",e),alert("Error deleting appointment")}})(e.getAttribute("data-id"))})})}}else console.error("Failed to fetch appointments")}catch(e){console.error("Error fetching appointments:",e)}}o.addEventListener("submit",async e=>{e.preventDefault();let t=i.value;var n,e=l.value.trim(),a=r.value.trim();t&&e?(-1!==(n=s.plans.findIndex(e=>e.day===t))?(n=s.plans[n]).planTitles.includes(e)||(n.planTitles.push(e),a&&(n.notes=n.notes?n.notes+" | "+a:a)):s.plans.push({day:t,planTitles:[e],notes:a||""}),await d(),c(),o.reset()):alert("Please select a day and enter a plan title.")});let m=document.getElementById("bookingForm");m.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("trainerSelect").value,t=document.getElementById("appointmentDate").value,n=document.getElementById("appointmentTime").value,a=document.getElementById("appointmentNotes").value.trim();if(e&&t&&n)try{var o,i=await fetch("/api/appointments",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({trainerId:e,date:t,time:n,notes:a})});i.ok?(alert("Appointment booked successfully!"),m.reset(),p()):(o=await i.json(),alert("Failed to book appointment: "+o.msg))}catch(e){console.error("Error booking appointment:",e),alert("Error booking appointment")}else alert("Please select a trainer, date, and time.")}),(async()=>{try{var e,t=await fetch("/api/auth/schedule",{headers:{"Content-Type":"application/json"},credentials:"include"});t.ok?(e=await t.json())&&e.lastReset&&e.plans&&(s=e,n=new Date(s.lastReset),a=new Date,n=a-n,7<=(n/=864e5)&&(s.plans=[],s.lastReset=a.toISOString(),d()),c()):console.error("Failed to fetch schedule")}catch(e){console.error("Error fetching schedule:",e)}var n,a})(),p(),p(),(async()=>{try{var e=await fetch("/api/users/trainers",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(e.ok){var n=await e.json();let t=document.getElementById("trainerSelect");t.innerHTML='<option value="">Choose...</option>',n.forEach(e=>{t.innerHTML+=`<option value="${e._id}">${e.firstName} ${e.lastName}</option>`})}else console.error("Failed to fetch trainers")}catch(e){console.error("Error fetching trainers:",e)}})()});