let isLocalhost=["localhost","127.0.0.1"].includes(window.location.hostname),API_BASE_URL=isLocalhost?"http://localhost:10000":"https://jefitness.onrender.com",currentPage=1,currentSearch="",currentSortBy="firstName",currentSortOrder="asc",currentStatus="",currentAppointmentsSortBy="date",currentAppointmentsSortOrder="asc";function debounce(e,n){let a;return function(...t){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...t)},n)}}async function loadClients(t=1,e="",n="firstName",a="asc",r=""){try{showLoading(!0);var o=new URLSearchParams({page:t,limit:10,search:e,sortBy:n,sortOrder:a,status:r}),i=await fetch(API_BASE_URL+"/api/clients?"+o,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(!i.ok)throw new Error(`HTTP ${i.status} - `+i.statusText);var{clients:l,pagination:s}=await i.json();displayClients(l),updatePagination(s),updateStatistics(),showLoading(!1)}catch(t){console.error("Error loading clients:",t),showError("Failed to load clients. Please try again."),showLoading(!1)}}function displayClients(t){let n=document.getElementById("clientTableBody");n.innerHTML="",0===t.length?n.innerHTML=`
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                    ${currentSearch?"No clients found matching your search.":"No clients found"}
                </td>
            </tr>
        `:(t.forEach(t=>{var e=document.createElement("tr");e.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer user-detail" data-id="${t._id}">${t.firstName||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer user-detail" data-id="${t._id}">${t.lastName||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer user-detail" data-id="${t._id}">${t.email||"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${"active"===t.activityStatus?"bg-green-100 text-green-800":"inactive"===t.activityStatus?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}">
                    ${t.activityStatus||"Unknown"}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.createdAt?new Date(t.createdAt).toLocaleDateString():"N/A"}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-id="${t._id}" class="text-blue-600 hover:text-blue-900 mr-3 view-btn">View</button>
                <button data-id="${t._id}" class="text-blue-600 hover:text-blue-900 mr-3 edit-btn">Edit</button>
                <button data-id="${t._id}" class="text-red-600 hover:text-red-900 delete-btn">Delete</button>
            </td>
        `,n.appendChild(e)}),document.querySelectorAll(".view-btn").forEach(t=>{t.addEventListener("click",t=>showUserDetails(t.target.dataset.id))}),document.querySelectorAll(".user-detail").forEach(t=>{t.addEventListener("click",t=>showUserDetails(t.target.dataset.id))}),document.querySelectorAll(".edit-btn").forEach(t=>{t.addEventListener("click",t=>editClient(t.target.dataset.id))}),document.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",t=>confirmDeleteClient(t.target.dataset.id))}))}async function showUserDetails(t){var e=document.getElementById("userDetailsModal"),n=document.getElementById("userDetailsContent"),r=document.getElementById("userDetailsLoading");e.classList.remove("hidden"),r.style.display="block",n.querySelectorAll(":not(#userDetailsLoading)").forEach(t=>t.remove());try{var o=await fetch(API_BASE_URL+"/api/clients/"+t,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(!o.ok)throw new Error(`HTTP ${o.status} - `+o.statusText);var i=(await o.json()).client;r.style.display="none";let a=document.createElement("div");if(a.classList.add("space-y-2"),[{label:"First Name",value:i.firstName},{label:"Last Name",value:i.lastName},{label:"Email",value:i.email},{label:"Date of Birth",value:i.dob?new Date(i.dob).toLocaleDateString():"N/A"},{label:"Gender",value:i.gender||"N/A"},{label:"Phone",value:i.phone||"N/A"},{label:"Activity Status",value:i.activityStatus||"N/A"},{label:"Start Weight",value:void 0!==i.startWeight?i.startWeight:"N/A"},{label:"Current Weight",value:void 0!==i.currentWeight?i.currentWeight:"N/A"},{label:"Goals",value:i.goals||"N/A"},{label:"Reason",value:i.reason||"N/A"},{label:"Last Logged In",value:i.lastLoggedIn?new Date(i.lastLoggedIn).toLocaleString():"Never"}].forEach(t=>{var e=document.createElement("p");e.innerHTML=`<strong>${t.label}:</strong> `+t.value,a.appendChild(e)}),i.nutritionLogs&&0<i.nutritionLogs.length){var l=document.createElement("h3");l.textContent="Nutrition Logs",l.classList.add("text-lg","font-semibold","mt-4"),a.appendChild(l);let n=document.createElement("ul");n.classList.add("list-disc","pl-5","max-h-40","overflow-y-auto","border","p-2","rounded"),i.nutritionLogs.forEach(t=>{var e=document.createElement("li");e.textContent=t.date+` - ${t.mealType}: ${t.foodItem} (${t.calories} cal)`,n.appendChild(e)}),a.appendChild(n)}if(i.sleepLogs&&0<i.sleepLogs.length){var s=document.createElement("h3");s.textContent="Sleep Logs",s.classList.add("text-lg","font-semibold","mt-4"),a.appendChild(s);let n=document.createElement("ul");n.classList.add("list-disc","pl-5","max-h-40","overflow-y-auto","border","p-2","rounded"),i.sleepLogs.forEach(t=>{var e=document.createElement("li");e.textContent=`${new Date(t.date).toLocaleDateString()}: ${t.hoursSlept} hours`,n.appendChild(e)}),a.appendChild(n)}n.appendChild(a)}catch(t){console.error("Error loading user details:",t),r.style.display="none",n.innerHTML='<p class="text-red-600">Failed to load user details. Please try again.</p>'}}function updatePagination(t){var n=document.getElementById("paginationInfo"),a=document.getElementById("clientPagination");let{currentPage:r,totalPages:o,totalClients:e}=t;var t=10*(r-1)+1,i=Math.min(10*r,e);if(n.textContent=`Showing ${t} to ${i} of ${e} entries`,a.innerHTML="",!(o<=1)){n=document.createElement("li");n.innerHTML=`
        <button class="px-3 py-1 rounded-md ${1===r?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}" 
                ${1===r?"disabled":""}>
            Previous
        </button>
    `,1<r&&n.querySelector("button").addEventListener("click",()=>changePage(r-1)),a.appendChild(n);let e=Math.max(1,r-Math.floor(2.5));var l=Math.min(o,e+5-1);for(let t=e=l-e<4?Math.max(1,l-5+1):e;t<=l;t++){var s=document.createElement("li");s.innerHTML=`
            <button class="px-3 py-1 rounded-md ${t===r?"bg-blue-500 text-white":"bg-gray-200 hover:bg-gray-300"}">
                ${t}
            </button>
        `,t!==r&&s.querySelector("button").addEventListener("click",()=>changePage(t)),a.appendChild(s)}t=document.createElement("li");t.innerHTML=`
        <button class="px-3 py-1 rounded-md ${r===o?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}" 
                ${r===o?"disabled":""}>
            Next
        </button>
    `,r<o&&t.querySelector("button").addEventListener("click",()=>changePage(r+1)),a.appendChild(t)}}async function updateStatistics(){try{var t=await fetch(API_BASE_URL+"/api/clients/statistics",{headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error(`HTTP ${t.status} - `+t.statusText);var e=await t.json(),n=document.getElementById("totalClientsCount"),a=document.getElementById("activeClientsCount"),r=document.getElementById("avgCaloriesCount"),o=document.getElementById("avgSleepCount");n&&(n.textContent=e.totalClients),a&&(a.textContent=e.activeClients),r&&(r.textContent=e.avgCalories),o&&(o.textContent=e.avgSleep),updateTopClientsFromStats(e.topPerformers)}catch(t){console.error("Error loading statistics:",t)}}function updateTopClientsFromStats(t){var e=document.querySelector("#top-clients-section .bg-red-100 p.text-xl"),e=(e&&t.topCalorieBurner&&(e.textContent=t.topCalorieBurner.name),document.querySelector("#top-clients-section .bg-indigo-100 p.text-xl")),e=(e&&t.bestSleeper&&(e.textContent=t.bestSleeper.name),document.querySelector("#top-clients-section .bg-green-100 p.text-xl"));e&&t.mostActive&&(e.textContent=t.mostActive.name)}function changePage(t){loadClients(currentPage=t,currentSearch,currentSortBy,currentSortOrder,currentStatus)}document.addEventListener("DOMContentLoaded",()=>{var t=document.getElementById("closeUserDetailsModal");let e=document.getElementById("userDetailsModal");t.addEventListener("click",()=>{e.classList.add("hidden")}),e.addEventListener("click",t=>{t.target===e&&e.classList.add("hidden")});t=document.getElementById("closeAppointmentDetailsModal");let n=document.getElementById("appointmentDetailsModal");t.addEventListener("click",()=>{n.classList.add("hidden")}),n.addEventListener("click",t=>{t.target===n&&n.classList.add("hidden")})});let debouncedSearch=debounce(t=>{currentSearch=t,loadClients(currentPage=1,currentSearch,currentSortBy,currentSortOrder,currentStatus)},300);function handleSort(t){currentSortOrder=currentSortBy===t?"asc"===currentSortOrder?"desc":"asc":(currentSortBy=t,"asc"),loadClients(currentPage=1,currentSearch,currentSortBy,currentSortOrder,currentStatus),updateSortIndicators()}function updateSortIndicators(){document.querySelectorAll("[data-sort]").forEach(t=>{var e=t.dataset.sort,t=t.querySelector("i");e===currentSortBy?t.className="asc"===currentSortOrder?"bi bi-sort-alpha-up ml-1":"bi bi-sort-alpha-down-alt ml-1":t.className="bi bi-sort-alpha-down ml-1"})}function handleAppointmentsSort(t){currentAppointmentsSortOrder=currentAppointmentsSortBy===t?"asc"===currentAppointmentsSortOrder?"desc":"asc":(currentAppointmentsSortBy=t,"asc"),loadAppointments(1,"",currentAppointmentsSortBy,currentAppointmentsSortOrder,""),updateAppointmentsSortIndicators()}function updateAppointmentsSortIndicators(){document.querySelectorAll("#appointments-section [data-sort]").forEach(t=>{var e=t.dataset.sort,t=t.querySelector("i");e===currentAppointmentsSortBy?t.className="asc"===currentAppointmentsSortOrder?"bi bi-sort-up ml-1":"bi bi-sort-down ml-1":t.className="bi bi-sort-down ml-1"})}function showLoading(t){var e=document.getElementById("clientTableBody");t&&(e.innerHTML=`
            <tr>
                <td colspan="6" class="px-6 py-4 text-center">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-2">Loading clients...</span>
                    </div>
                </td>
            </tr>
        `)}function showError(t){document.getElementById("clientTableBody").innerHTML=`
        <tr>
            <td colspan="6" class="px-6 py-4 text-center text-red-600">
                <i class="bi bi-exclamation-triangle mr-2"></i>${t}
            </td>
        </tr>
    `}function editClient(t){console.log("Edit client:",t)}function confirmDeleteClient(t){confirm("Are you sure you want to delete this client?")&&deleteClient(t)}async function deleteClient(t){try{var e=await fetch(API_BASE_URL+"/api/clients/"+t,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error(`HTTP ${e.status} - `+e.statusText);loadClients(currentPage,currentSearch,currentSortBy,currentSortOrder,currentStatus)}catch(t){console.error("Error deleting client:",t),alert("Failed to delete client. Please try again.")}}async function loadAppointments(t=1,e="",n=currentAppointmentsSortBy,a=currentAppointmentsSortOrder,r=""){try{var o=new URLSearchParams({page:t,limit:10,search:e,sortBy:n,sortOrder:a,status:r}),i=await fetch(API_BASE_URL+"/api/appointments?"+o,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(!i.ok)throw new Error(`HTTP ${i.status} - `+i.statusText);var{appointments:l,pagination:s}=await i.json();displayAppointments(l),updateAppointmentsPagination(s)}catch(t){console.error("Error loading appointments:",t),showAppointmentsError("Failed to load appointments. Please try again.")}}function displayAppointments(t){let i=document.getElementById("appointmentsTableBody");i.innerHTML="",0===t.length?i.innerHTML=`
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                    No appointments found
                </td>
            </tr>
        `:(t.forEach(t=>{var e=document.createElement("tr"),n=new Date(t.date).toLocaleDateString(),a="scheduled"===t.status?"bg-green-100 text-green-800":"cancelled"===t.status?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800",r=t.clientId?`${t.clientId.firstName||"N/A"} `+(t.clientId.lastName||""):"N/A",o=t.trainerId?`${t.trainerId.firstName||"N/A"} `+(t.trainerId.lastName||""):"N/A";e.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${n}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.time}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${o}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${a}">
                    ${t.status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button data-id="${t._id}" class="text-blue-600 hover:text-blue-900 mr-3 view-appointment-btn">View</button>
                <button data-id="${t._id}" class="text-blue-600 hover:text-blue-900 mr-3 edit-appointment-btn">Edit</button>
                <button data-id="${t._id}" class="text-red-600 hover:text-red-900 delete-appointment-btn">Delete</button>
            </td>
        `,i.appendChild(e)}),document.querySelectorAll(".view-appointment-btn").forEach(t=>{t.addEventListener("click",t=>viewAppointment(t.target.dataset.id))}),document.querySelectorAll(".edit-appointment-btn").forEach(t=>{t.addEventListener("click",t=>editAppointment(t.target.dataset.id))}),document.querySelectorAll(".delete-appointment-btn").forEach(t=>{t.addEventListener("click",t=>confirmDeleteAppointment(t.target.dataset.id))}))}function updateAppointmentsPagination(t){var n=document.getElementById("appointmentsPaginationInfo"),a=document.getElementById("appointmentsPagination");let{currentPage:r,totalPages:o,totalAppointments:e}=t;var t=10*(r-1)+1,i=Math.min(10*r,e);if(n.textContent=`Showing ${t} to ${i} of ${e} entries`,a.innerHTML="",!(o<=1)){n=document.createElement("li");n.innerHTML=`
        <button class="px-3 py-1 rounded-md ${1===r?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}"
                ${1===r?"disabled":""}>
            Previous
        </button>
    `,1<r&&n.querySelector("button").addEventListener("click",()=>changeAppointmentsPage(r-1)),a.appendChild(n);let e=Math.max(1,r-Math.floor(2.5));var l=Math.min(o,e+5-1);for(let t=e=l-e<4?Math.max(1,l-5+1):e;t<=l;t++){var s=document.createElement("li");s.innerHTML=`
            <button class="px-3 py-1 rounded-md ${t===r?"bg-blue-500 text-white":"bg-gray-200 hover:bg-gray-300"}">
                ${t}
            </button>
        `,t!==r&&s.querySelector("button").addEventListener("click",()=>changeAppointmentsPage(t)),a.appendChild(s)}t=document.createElement("li");t.innerHTML=`
        <button class="px-3 py-1 rounded-md ${r===o?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}"
                ${r===o?"disabled":""}>
            Next
        </button>
    `,r<o&&t.querySelector("button").addEventListener("click",()=>changeAppointmentsPage(r+1)),a.appendChild(t)}}function changeAppointmentsPage(t){loadAppointments(t,"",currentAppointmentsSortBy,currentAppointmentsSortOrder,"")}function showAppointmentsError(t){document.getElementById("appointmentsTableBody").innerHTML=`
        <tr>
            <td colspan="6" class="px-6 py-4 text-center text-red-600">
                <i class="bi bi-exclamation-triangle mr-2"></i>${t}
            </td>
        </tr>
    `}async function viewAppointment(t){var e=document.getElementById("appointmentDetailsModal"),n=document.getElementById("appointmentDetailsContent"),a=document.getElementById("appointmentDetailsLoading");e.classList.remove("hidden"),a.style.display="block",n.querySelectorAll(":not(#appointmentDetailsLoading)").forEach(t=>t.remove());try{var r=await fetch(API_BASE_URL+"/api/appointments/"+t,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")}});if(!r.ok)throw new Error(`HTTP ${r.status} - `+r.statusText);var o=await r.json();a.style.display="none",document.getElementById("modalAppointmentDate").textContent=new Date(o.date).toLocaleDateString(),document.getElementById("modalAppointmentTime").textContent=o.time,document.getElementById("modalAppointmentClient").textContent=o.clientId?o.clientId.firstName+" "+o.clientId.lastName:"N/A",document.getElementById("modalAppointmentTrainer").textContent=o.trainerId?o.trainerId.firstName+" "+o.trainerId.lastName:"N/A",document.getElementById("modalAppointmentStatus").textContent=o.status,document.getElementById("modalAppointmentNotes").textContent=o.notes||"N/A",document.getElementById("modalAppointmentCreatedAt").textContent=new Date(o.createdAt).toLocaleString(),document.getElementById("modalAppointmentUpdatedAt").textContent=new Date(o.updatedAt).toLocaleString()}catch(t){console.error("Error loading appointment details:",t),a.style.display="none",n.innerHTML='<p class="text-red-600">Failed to load appointment details. Please try again.</p>'}}function editAppointment(t){console.log("Edit appointment:",t)}function confirmDeleteAppointment(t){confirm("Are you sure you want to delete this appointment?")&&deleteAppointment(t)}async function deleteAppointment(t){try{var e=await fetch(API_BASE_URL+"/api/appointments/"+t,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error(`HTTP ${e.status} - `+e.statusText);loadAppointments(1,"","date","asc","")}catch(t){console.error("Error deleting appointment:",t),alert("Failed to delete appointment. Please try again.")}}function exportAppointments(){fetch(API_BASE_URL+"/api/appointments",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}}).then(t=>t.json()).then(t=>{var e,t=t.appointments||[];0===t.length?alert("No appointments to export"):(t=[["Date","Time","Client Name","Client Email","Trainer Name","Trainer Email","Status","Notes"],...t.map(t=>[new Date(t.date).toLocaleDateString(),t.time,t.clientId.firstName+" "+t.clientId.lastName,t.clientId.email,t.trainerId.firstName+" "+t.trainerId.lastName,t.trainerId.email,t.status,t.notes||""])].map(t=>t.join(",")).join("\n"),t=new Blob([t],{type:"text/csv"}),t=window.URL.createObjectURL(t),(e=document.createElement("a")).href=t,e.download=`appointments_${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(t))}).catch(t=>{console.error("Error exporting appointments:",t),alert("Failed to export appointments. Please try again.")})}function attachLogoutListener(){var t=document.getElementById("logoutBtn");t&&t.addEventListener("click",()=>{localStorage.removeItem("token"),window.location.href="/pages/login.html"})}document.addEventListener("DOMContentLoaded",()=>{loadClients(),loadAppointments(),attachLogoutListener();var t=document.getElementById("clientSearch"),t=(t&&t.addEventListener("input",t=>{debouncedSearch(t.target.value)}),document.querySelectorAll("[data-sort]").forEach(t=>{t.addEventListener("click",()=>{handleSort(t.dataset.sort)})}),document.getElementById("statusFilter")),t=(t&&t.addEventListener("change",t=>{currentStatus=t.target.value,loadClients(currentPage=1,currentSearch,currentSortBy,currentSortOrder,currentStatus)}),document.getElementById("refreshAppointments")),t=(t&&t.addEventListener("click",()=>{loadAppointments(1,"",currentAppointmentsSortBy,currentAppointmentsSortOrder,"")}),document.querySelectorAll("#appointments-section [data-sort]").forEach(t=>{t.addEventListener("click",()=>{handleAppointmentsSort(t.dataset.sort)})}),document.getElementById("exportAppointments")),t=(t&&t.addEventListener("click",exportAppointments),document.getElementById("refreshClients"));t&&t.addEventListener("click",()=>{loadClients(currentPage,currentSearch,currentSortBy,currentSortOrder,currentStatus)})});